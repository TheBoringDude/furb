{% extends 'layout.html' %}

{% block title %}
Grab {{manga}}
{% endblock title %}

{% block content %}
<div class="py-12 w-5/6 mx-auto">
    <div>
        <h1 class="text-xl font-black tracking-wide text-blue-600">furb</h1>
    </div>
    <hr>

    <div class="w-3/4 mx-auto py-2">
        <form action="/" method="POST">
            <label for="" class="text-lg font-light tracking-wide">Manhwa / Manga URL</label>
            <div class="flex items-center justify-center w-11/12 mx-auto py-1">
                <input type="text" name="url" class="py-1 px-2 text-lg border-b-2 font-thin tracking-wide mx-2 w-full text-blue-500 focus:border-blue-500 focus:outline-none" placeholder="Enter the url of the manga to grab..." value="{{query}}">
                <input type="submit" value="GRAB" class="py-1 px-6 bg-blue-500 hover:bg-blue-600 cursor-pointer tracking-wide rounded text-white">
            </div>
        </form>

        <div class="pt-6">
            <h4 class="font-light tracking-wide">Chapters:</h4>
            <hr class="my-3">
            <div class="w-11/12 mx-auto">
                <div class="flex items-center justify-between my-2">
                    <h3 class="font-light tracking-wide">Manga: <span class="text-blue-500 font-bold truncate">{{manga}}</span></h3>
                    <h3 class="font-light tracking-wide">Source: <span class="underline font-normal uppercase">{{source}}</span></h3>
                </div>
                <ul class="max-h-screen h-auto overflow-y-scroll p-2">
                    {% for chapter in results %}
                    <li class="flex items-center justify-between py-2 px-4 rounded bg-gray-100 font-light my-1">
                        <p class="w-full tracking-wide truncate">{{chapter.chapter_name}}</p>
                        <form action="" method="POST" id="form-gen-dl" key="{{chapter.chapter_url}}" onsubmit="generateDownload(event, this)">
                            <input type="hidden" name="chapter-url" value="{{chapter.b64_hash}}">
                            <button id="generate-dl"  type="submit" class="bg-green-600 opacity-75 hover:opacity-100 cursor-pointer text-white font-light rounded py-1 px-4 tracking-wider">Generate</button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block ajax %}
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    function generateDownload(e, form){
        // prevent default action submit
        e.preventDefault()

        // get the button
        var btnGen = form.querySelector("button")

        // set the button text to generating
        btnGen.innerHTML = 'Generating...'
        btnGen.disabled = true;

        // get the chapter_url value
        const chapter_url = form['chapter-url'].value

        let rdata = {};
        
        // fetch
        axios.post('/get/q/' + chapter_url).then((resp) => {
            if ((resp.status !== 200) || (resp.data['code'] !== 200)){
                btnGen.disabled = true; // disable the button
                btnGen.innerHTML = 'ERROR!';
                return;
            }

            data = resp.data

            // set the datas
            rdata = {
                'title' : data['data']['title'],
                'dl_link' : data['data']['link']
            }

            // set the button
            btnGen.type = 'button';
            btnGen.disabled = false;
            btnGen.innerHTML = 'DOWNLOAD';
            btnGen.classList.remove('bg-green-600');
            btnGen.classList.add('bg-green-500');
        }).catch((err) => {
            btnGen.disabled = false;
            btnGen.innerHTML = 'retry';
            console.error(err) // log the error
        })

        btnGen.onclick = () => {
            if (rdata) {
                window.open('/download/q/' + window.btoa(JSON.stringify(rdata)), '_blank');
            }
        }
    }
</script>
{% endblock ajax %}